const express = require("express");
const multer = require("multer");
const cors = require("cors");
const fs = require("fs");
const path = require("path");
const { spawn } = require("child_process");

const app = express();
const PORT = 3001;

app.use(cors());
app.use(express.json());

const upload = multer({ dest: "temp_uploads/" });

const analysisScript = path.join(__dirname, "analysis.py");

// Route ch·∫°y ph√¢n t√≠ch chuy√™n s√¢u
app.post("/run-analysis/:profileName", (req, res) => {
  const profileName = req.params.profileName;

  const process = spawn("python", [analysisScript, profileName]);

  process.stdout.on("data", (data) => {
    console.log(`[Analysis Output] ${data.toString()}`);
  });

  process.stderr.on("data", (data) => {
    console.error(`[Analysis Error] ${data.toString()}`);
  });

  process.on("close", (code) => {
    if (code === 0) {
      res.json({ success: true });
    } else {
      res.status(500).json({ success: false, error: `Script l·ªói v·ªõi m√£ ${code}` });
    }
  });
});

// Route ƒë·ªçc n·ªôi dung ph√¢n t√≠ch
app.get("/analysis-result/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const pathToTxt = path.join(__dirname, "final_analysis", profileName, "analysis.txt");

  if (!fs.existsSync(pathToTxt)) {
    return res.status(404).send("Ch∆∞a c√≥ ph√¢n t√≠ch chuy√™n s√¢u.");
  }

  const content = fs.readFileSync(pathToTxt, "utf-8");
  res.type("text/plain").send(content);
});

app.post("/upload", upload.array("files"), (req, res) => {
  const profileName = req.body.profileName;
  const files = req.files;
  const uploadedBy = req.body.uploadedBy;
  const avatar = req.body.avatar;


  if (!profileName || !files.length) {
    return res.status(400).json({ success: false, error: "Thi·∫øu t√™n h·ªì s∆° ho·∫∑c file." });
  }

  const folderPath = path.join(__dirname, "kb", profileName);
  if (!fs.existsSync(folderPath)) {
    fs.mkdirSync(folderPath, { recursive: true });
  }

  const record = {
    id: "HS-" + Date.now(),
    title: profileName,
    date: new Date().toISOString(),
    files: [],
    uploadedBy: req.body.uploadedBy,
    avatar: req.body.avatar,
  };

  files.forEach((file) => {
    const newPath = path.join(folderPath, file.originalname);
    fs.renameSync(file.path, newPath);
    record.files.push(file.originalname);
  });

  const infoPath = path.join(folderPath, "info.json");
  fs.writeFileSync(infoPath, JSON.stringify(record, null, 2));

  res.json({ success: true, record });
});

app.get("/records", (req, res) => {
  const baseDir = path.join(__dirname, "kb");
  const uploadedBaseDir = path.join(__dirname, "uploaded_kb_files");

  if (!fs.existsSync(baseDir)) return res.json([]);

  const folders = fs.readdirSync(baseDir);
  const results = [];

  folders.forEach((folder) => {
    const infoPath = path.join(baseDir, folder, "info.json");
    if (fs.existsSync(infoPath)) {
      try {
        const content = fs.readFileSync(infoPath, "utf-8");
        const record = JSON.parse(content);

        // ‚úÖ Ki·ªÉm tra n·∫øu folder ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω OCR (n·∫±m trong uploaded_kb_files/)
        const uploadedPath = path.join(uploadedBaseDir, folder);
        record.ocrDone = fs.existsSync(uploadedPath);

        results.push(record);
      } catch (e) {
        console.error("‚ùå L·ªói ƒë·ªçc info.json:", e);
      }
    }
  });

  res.json(results);
});

app.get("/files/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const folderPath = path.join(__dirname, "kb", profileName);

  if (!fs.existsSync(folderPath)) {
    return res.status(404).json({ files: [] });
  }

  const fileList = fs.readdirSync(folderPath)
    .filter(file => file !== "info.json")
    .map(file => {
      const filePath = path.join(folderPath, file);
      const stats = fs.statSync(filePath);
      return { name: file, size: stats.size };
    });

  res.json({ files: fileList });
});

app.use('/kb', express.static(path.join(__dirname, 'kb')));

app.post("/classify-profile", (req, res) => {
  const profileName = req.body.profileName;
  const profilePath = path.join(__dirname, "kb", profileName);

  console.log("üî• Nh·∫≠n y√™u c·∫ßu classify-profile:", profileName);

  if (!fs.existsSync(profilePath)) {
    console.error("‚ùå H·ªì s∆° kh√¥ng t·ªìn t·∫°i:", profilePath);
    return res.status(404).json({ success: false, error: "H·ªì s∆° kh√¥ng t·ªìn t·∫°i" });
  }

  try {
    // === CH·∫†Y CLASSIFIER TR∆Ø·ªöC ===
    const classifierProcess = spawn("python", ["classifier.py", profilePath, profileName]);

    classifierProcess.stdout.on("data", (data) => {
      console.log(`[Classifier Output] ${data.toString()}`);
    });

    classifierProcess.stderr.on("data", (data) => {
      console.error(`[Classifier Error] ${data.toString()}`);
    });

    classifierProcess.on("close", (code) => {
      if (code !== 0) {
        console.error(`‚ùå Classifier k·∫øt th√∫c v·ªõi m√£ l·ªói ${code}`);
        return res.status(500).json({ success: false, error: `Classifier l·ªói (exit code ${code})` });
      }

      // === SAU KHI CLASSIFY XONG M·ªöI CH·∫†Y OCR ===
      const ocrScriptPath = path.join(__dirname, "ocr.py"); // ƒê∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·∫øn ocr.py

    const ocrProcess = spawn("python", [ocrScriptPath, profileName], {
      cwd: path.join(__dirname, "kb", profileName), // N∆°i ch·ª©a file c·∫ßn OCR
    });

      ocrProcess.stdout.on("data", (data) => {
        console.log(`[OCR Output] ${data.toString()}`);
      });

      ocrProcess.stderr.on("data", (data) => {
        console.error(`[OCR Error] ${data.toString()}`);
      });

      ocrProcess.on("close", (ocrCode) => {
        if (ocrCode === 0) {
          console.log(`‚úÖ ƒê√£ ho√†n t·∫•t OCR cho "${profileName}"`);
          res.json({ success: true, message: `ƒê√£ ph√¢n lo·∫°i v√† OCR h·ªì s∆° "${profileName}" th√†nh c√¥ng.` });
        } else {
          console.error(`‚ùå OCR k·∫øt th√∫c v·ªõi m√£ l·ªói ${ocrCode}`);
          res.status(500).json({ success: false, error: `OCR l·ªói (exit code ${ocrCode})` });
        }
      });
    });
  } catch (error) {
    console.error("‚ùå L·ªói khi spawn classifier ho·∫∑c ocr:", error);
    res.status(500).json({ success: false, error: "Server l·ªói khi ch·∫°y classifier ho·∫∑c OCR." });
  }
});

app.post("/login", (req, res) => {
  const { username, password } = req.body;
  const usersPath = path.join(__dirname, "users.json");

  if (!fs.existsSync(usersPath)) {
    return res.status(500).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y file ng∆∞·ªùi d√πng." });
  }

  const users = JSON.parse(fs.readFileSync(usersPath, "utf-8"));
  const user = users.find(u => u.username === username && u.password === password);

  if (!user) {
    return res.status(401).json({ success: false, error: "Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u." });
  }

  const { password: _, ...userInfo } = user; // lo·∫°i b·ªè password khi tr·∫£ v·ªÅ
  res.json({ success: true, user: userInfo });
});


app.get("/ocr-files/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const folderPath = path.join(__dirname, "uploaded_kb_files", profileName, "OCR");

  if (!fs.existsSync(folderPath)) {
    return res.status(404).json({ files: [] });
  }

  const fileList = fs.readdirSync(folderPath).map((file) => {
    const pdfName = file.replace(/^final_/, '').replace('.txt', '.pdf');
    return {
      name: file,
      url: `http://localhost:3001/ocr/${encodeURIComponent(profileName)}/OCR/${encodeURIComponent(file)}`,
      originalPdfUrl: `http://localhost:3001/pdf-file/${encodeURIComponent(profileName)}/${encodeURIComponent(pdfName)}`
    };
  });


  res.json({ files: fileList });
});

// Cho ph√©p truy c·∫≠p file OCR qua URL
app.use("/ocr", express.static(path.join(__dirname, "uploaded_kb_files")));


// ‚úÖ Route g·ªçi script financial-assistant.py ƒë·ªÉ ph√¢n t√≠ch th√¥ng tin t·ª´ OCR
app.post("/analyze-profile/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const profileFolderPath = path.join(__dirname, "uploaded_kb_files", profileName, "OCR");

  if (!fs.existsSync(profileFolderPath)) {
    return res.status(404).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c OCR c·ªßa h·ªì s∆°." });
  }

  const scriptPath = path.join(__dirname, "Financial-assistant.py");

  const analyzeProcess = spawn("python", [scriptPath, profileName], {
    env: process.env,
    cwd: __dirname,
  });

  analyzeProcess.stdout.on("data", (data) => {
    console.log(`[Analyze Output] ${data.toString()}`);
  });

  analyzeProcess.stderr.on("data", (data) => {
    console.error(`[Analyze Error] ${data.toString()}`);
  });

  analyzeProcess.on("close", (code) => {
    if (code === 0) {
      console.log(`‚úÖ ƒê√£ ho√†n t·∫•t ph√¢n t√≠ch h·ªì s∆° "${profileName}"`);
      res.json({ success: true });
    } else {
      console.error(`‚ùå Script financial-assistant.py l·ªói (exit code ${code})`);
      res.status(500).json({ success: false, error: `Script l·ªói (exit code ${code})` });
    }
  });
});


app.get("/analyze-result/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const resultPath = path.join(__dirname, "final_analysis",profileName, "final_output.json");

  if (!fs.existsSync(resultPath)) {
    return res.status(404).json({ error: "Ch∆∞a c√≥ file k·∫øt qu·∫£ ph√¢n t√≠ch." });
  }

  try {
    const content = fs.readFileSync(resultPath, "utf-8");
    const json = JSON.parse(content);
    res.json(json);
  } catch (err) {
    console.error("‚ùå L·ªói ƒë·ªçc final_output.json:", err);
    res.status(500).json({ error: "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file k·∫øt qu·∫£." });
  }
});


// Tr·∫£ v·ªÅ file PDF g·ªëc
app.get("/pdf-file/:profileName/:pdfName", (req, res) => {
  const { profileName, pdfName } = req.params;
  const filePath = path.join(__dirname, "kb", profileName, pdfName);

  if (fs.existsSync(filePath)) {
    res.sendFile(filePath);
  } else {
    res.status(404).send("Kh√¥ng t√¨m th·∫•y file PDF.");
  }
});


app.get("/page-image/:profileName/:fileName/:pageNumber", (req, res) => {
  const { profileName, fileName, pageNumber } = req.params;

  const baseName = fileName.replace(/^final_/, "").replace(/\.txt$/, "");

  const tryPaths = [
    path.join(__dirname, "uploaded_kb_files", profileName, "big_folders", `${baseName}${pageNumber}.png`),
    path.join(__dirname, "uploaded_kb_files", profileName, "light_folders", `${baseName}${pageNumber}.png`)
  ];

  for (const imagePath of tryPaths) {
    if (fs.existsSync(imagePath)) {
      return res.sendFile(imagePath);
    }
  }

  return res.status(404).send("Kh√¥ng t√¨m th·∫•y ·∫£nh trang t∆∞∆°ng ·ª©ng.");
});



app.post("/save-analyzed-result/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const resultPath = path.join(__dirname, "final_analysis", profileName, "final_output.json");

  try {
    fs.mkdirSync(path.dirname(resultPath), { recursive: true });
    fs.writeFileSync(resultPath, JSON.stringify(req.body, null, 2), "utf-8");
    res.json({ success: true });
  } catch (err) {
    console.error("‚ùå L·ªói khi l∆∞u JSON:", err);
    res.status(500).json({ success: false, error: "L·ªói khi l∆∞u JSON." });
  }
});


app.post("/generate-pdf", (req, res) => {
  const { profileName, bankName, organization, staffName } = req.body;

  if (!profileName || !bankName || !organization || !staffName) {
    return res.status(400).json({ success: false, error: "Thi·∫øu th√¥ng tin." });
  }
  console.log(`PDF making ...`);

  const scriptPath = path.join(__dirname, "pdf.py");

  const pdfProcess = spawn("python", [scriptPath, profileName, bankName, organization, staffName]);

  pdfProcess.stdout.on("data", (data) => {
    console.log(`[PDF Output] ${data.toString()}`);
  });

  pdfProcess.stderr.on("data", (data) => {
    console.error(`[PDF Error] ${data.toString()}`);
  });

  pdfProcess.on("close", (code) => {
    if (code === 0) {
      console.log(` "${profileName}"`);
      res.json({ success: true });
    } else {
      console.error(`(exit code ${code})`);
      res.status(500).json({ success: false });
    }
  });
});

app.get("/download-pdf/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const filePath = path.join(__dirname, "final_analysis", profileName, "to_trinh.pdf");

  if (fs.existsSync(filePath)) {
    res.download(filePath, `${profileName}_to_trinh.pdf`);
  } else {
    res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y file PDF." });
  }
});


app.post("/update-name", (req, res) => {
  const { username, newName } = req.body;
  const usersPath = path.join(__dirname, "users.json");

  if (!fs.existsSync(usersPath)) {
    return res.status(500).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y file ng∆∞·ªùi d√πng." });
  }

  const users = JSON.parse(fs.readFileSync(usersPath, "utf-8"));
  const userIndex = users.findIndex((u) => u.username === username);

  if (userIndex === -1) {
    return res.status(404).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng." });
  }

  users[userIndex].fullname = newName;
  fs.writeFileSync(usersPath, JSON.stringify(users, null, 2), "utf-8");

  res.json({ success: true });
});

app.post("/change-password", (req, res) => {
  const { username, currentPassword, newPassword } = req.body;
  const usersPath = path.join(__dirname, "users.json");

  if (!fs.existsSync(usersPath)) {
    return res.status(500).json({ success: false, error: "Kh√¥ng t√¨m th·∫•y file ng∆∞·ªùi d√πng." });
  }

  const users = JSON.parse(fs.readFileSync(usersPath, "utf-8"));
  const userIndex = users.findIndex((u) => u.username === username && u.password === currentPassword);

  if (userIndex === -1) {
    return res.status(401).json({ success: false, error: "Sai m·∫≠t kh·∫©u hi·ªán t·∫°i." });
  }

  users[userIndex].password = newPassword;
  fs.writeFileSync(usersPath, JSON.stringify(users, null, 2), "utf-8");

  res.json({ success: true });
});

// Route ch·∫°y checker.py
app.post("/check-profile/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const scriptPath = path.join(__dirname, "checker.py");

  const checkerProcess = spawn("python", [scriptPath, profileName]);

  checkerProcess.stdout.on("data", (data) => {
    console.log(`[Checker Output] ${data.toString()}`);
  });

  checkerProcess.stderr.on("data", (data) => {
    console.error(`[Checker Error] ${data.toString()}`);
  });

  checkerProcess.on("close", (code) => {
    if (code === 0) {
      res.json({ success: true });
    } else {
      res.status(500).json({ success: false, error: `Checker l·ªói (exit code ${code})` });
    }
  });
});

// Route tr·∫£ v·ªÅ n·ªôi dung checker.txt
app.get("/checker-result/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const filePath = path.join(__dirname, "final_analysis", profileName, "checker.txt");

  if (!fs.existsSync(filePath)) {
    return res.status(404).send("Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm tra.");
  }

  const text = fs.readFileSync(filePath, "utf-8");
  res.type("text/plain").send(text);
});


// üëâ Ch·∫°y detector.py
app.post("/detect-photoshop/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const scriptPath = path.join(__dirname, "detector.py");

  const detectProcess = spawn("python", [scriptPath, profileName]);

  detectProcess.stdout.on("data", (data) => {
    console.log(`[Detector Output] ${data.toString()}`);
  });

  detectProcess.stderr.on("data", (data) => {
    console.error(`[Detector Error] ${data.toString()}`);
  });

  detectProcess.on("close", (code) => {
    if (code === 0) {
      res.json({ success: true });
    } else {
      res.status(500).json({ success: false, error: `L·ªói detector.py (exit code ${code})` });
    }
  });
});

app.get("/detect-result/:profileName", (req, res) => {
  const profileName = req.params.profileName;
  const resultPath = path.join(__dirname, "final_analysis", profileName, "detect_result.txt");

  if (!fs.existsSync(resultPath)) {
    return res.status(404).send("Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm tra ch·ªØ k√Ω / photoshop.");
  }

  const text = fs.readFileSync(resultPath, "utf-8");
  res.type("text/plain").send(text);
});






app.listen(PORT, () => {
  console.log(`‚úÖ Server ƒëang ch·∫°y t·∫°i http://localhost:${PORT}`);
});
